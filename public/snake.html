<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Snake Battle ‚Äî MiniGames</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>

    <div id="lobby" class="lobby">
      <h1>üêç Snake Battle</h1>
      <div>
        <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      </div>
      <div style="margin-top:15px">
        <input type="text" id="codeInput" placeholder="–ö–æ–¥" maxlength="6">
        <button class="btn btn-secondary" onclick="joinRoom()">–í–æ–π—Ç–∏</button>
      </div>
      <div style="margin-top:15px">
        <button class="btn btn-secondary" onclick="playSolo()">–û–¥–Ω–æ–º—É</button>
      </div>
      <div id="roomInfo" class="hidden">
        <div class="room-code" id="roomCode"></div>
        <div class="info-bar">–ò–≥—Ä–æ–∫–æ–≤: <span id="playerCount">1</span>/4</div>
        <button class="btn" onclick="startGame()">–ù–∞—á–∞—Ç—å</button>
      </div>
    </div>

    <div id="gameScreen" class="game-area hidden">
      <div class="info-bar">–û—á–∫–∏: <span id="score">0</span></div>
      <canvas id="c"></canvas>

      <div class="touch-controls">
        <div class="touch-grid">
          <div class="touch-btn" ontouchstart="setDir(0,-1)" onclick="setDir(0,-1)">‚ñ≤</div>
          <div class="touch-btn" ontouchstart="setDir(-1,0)" onclick="setDir(-1,0)">‚óÑ</div>
          <div class="touch-btn" ontouchstart="setDir(1,0)" onclick="setDir(1,0)">‚ñ∫</div>
          <div class="touch-btn" ontouchstart="setDir(0,1)" onclick="setDir(0,1)">‚ñº</div>
        </div>
      </div>
    </div>
  </div>

<script>
const socket = io();
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let CELL, COLS = 20, ROWS = 20;
let myIndex = 0, solo = false, running = false, roomCode = null;
const COLORS = ['#667eea','#e74c3c','#2ecc71','#f39c12'];
let snake, dir, nextDir, food, score;
let others = {};

function resize() {
  const maxW = Math.min(window.innerWidth - 30, 600);
  CELL = Math.floor(maxW / COLS);
  canvas.width = COLS * CELL;
  canvas.height = ROWS * CELL;
}
resize();
window.addEventListener('resize', resize);

function initSnake(i) {
  const s = [[{x:3,y:3}],[{x:16,y:16}],[{x:16,y:3}],[{x:3,y:16}]];
  snake = s[i] ? [...s[i]] : [{x:3,y:3}];
  dir = {x:1,y:0}; nextDir = {x:1,y:0};
  score = 0; spawnFood();
}

function spawnFood() {
  food = {x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS)};
}

function setDir(x, y) {
  if (x === -dir.x && y === 0) return;
  if (y === -dir.y && x === 0) return;
  nextDir = {x, y};
}

function createRoom() {
  socket.emit('createRoom','snake',(code)=>{
    roomCode=code; myIndex=0;
    document.getElementById('roomCode').textContent=code;
    document.getElementById('roomInfo').classList.remove('hidden');
  });
}

function joinRoom() {
  const code=document.getElementById('codeInput').value.toUpperCase();
  socket.emit('joinRoom',code,(res)=>{
    if(res.error) return alert(res.error);
    roomCode=code; myIndex=res.playerIndex;
    document.getElementById('roomCode').textContent=code;
    document.getElementById('roomInfo').classList.remove('hidden');
    document.getElementById('playerCount').textContent=res.playerIndex+1;
  });
}

socket.on('playerJoined',(c)=>{document.getElementById('playerCount').textContent=c;});

function playSolo(){solo=true;myIndex=0;startGameNow();}
function startGame(){socket.emit('snakeStart');}
socket.on('snakeStart',()=>{startGameNow();});

function startGameNow(){
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  resize(); initSnake(myIndex); running=true; others={}; gameLoop();
}

function gameLoop(){
  if(!running)return;
  update(); draw();
  setTimeout(gameLoop,130);
}

function update(){
  dir=nextDir;
  const head={x:snake[0].x+dir.x, y:snake[0].y+dir.y};
  if(head.x<0)head.x=COLS-1; if(head.x>=COLS)head.x=0;
  if(head.y<0)head.y=ROWS-1; if(head.y>=ROWS)head.y=0;
  for(let s of snake){if(s.x===head.x&&s.y===head.y){initSnake(myIndex);return;}}
  snake.unshift(head);
  if(head.x===food.x&&head.y===food.y){
    score+=10; document.getElementById('score').textContent=score; spawnFood();
  } else snake.pop();
  if(!solo) socket.emit('snakeUpdate',{snake,score});
}

socket.on('snakeUpdate',(d)=>{others[d.id]=d;});

function draw(){
  const W=canvas.width, H=canvas.height;
  ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);

  ctx.strokeStyle='#1a1a2e';
  for(let i=0;i<=COLS;i++){ctx.beginPath();ctx.moveTo(i*CELL,0);ctx.lineTo(i*CELL,H);ctx.stroke();}
  for(let i=0;i<=ROWS;i++){ctx.beginPath();ctx.moveTo(0,i*CELL);ctx.lineTo(W,i*CELL);ctx.stroke();}

  ctx.fillStyle='#e74c3c'; ctx.shadowColor='#e74c3c'; ctx.shadowBlur=8;
  ctx.beginPath(); ctx.arc(food.x*CELL+CELL/2,food.y*CELL+CELL/2,CELL/2-2,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;

  drawSnake(snake,COLORS[myIndex]);

  let ci=1;
  for(let id in others){
    if(others[id].snake){
      if(ci===myIndex)ci++;
      drawSnake(others[id].snake,COLORS[ci%4]);
      ci++;
    }
  }
}

function drawSnake(s,color){
  for(let i=0;i<s.length;i++){
    ctx.globalAlpha=1-(i/s.length)*0.5;
    ctx.fillStyle=color;
    ctx.fillRect(s[i].x*CELL+1,s[i].y*CELL+1,CELL-2,CELL-2);
  }
  ctx.globalAlpha=1;
  ctx.fillStyle='#fff';
  const e=CELL*0.3;
  ctx.beginPath();
  ctx.arc(s[0].x*CELL+e,s[0].y*CELL+e,CELL*0.12,0,Math.PI*2);
  ctx.arc(s[0].x*CELL+CELL-e,s[0].y*CELL+e,CELL*0.12,0,Math.PI*2);
  ctx.fill();
}

document.addEventListener('keydown',(e)=>{
  switch(e.key){
    case'ArrowUp':case'w':case'W':setDir(0,-1);break;
    case'ArrowDown':case's':case'S':setDir(0,1);break;
    case'ArrowLeft':case'a':case'A':setDir(-1,0);break;
    case'ArrowRight':case'd':case'D':setDir(1,0);break;
  }
});

// –°–≤–∞–π–ø—ã
let tx=0,ty=0;
canvas.addEventListener('touchstart',(e)=>{
  const t=e.touches[0]; tx=t.clientX; ty=t.clientY;
},{passive:true});
canvas.addEventListener('touchend',(e)=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-tx, dy=t.clientY-ty;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>20)setDir(1,0); else if(dx<-20)setDir(-1,0);
  }else{
    if(dy>20)setDir(0,1); else if(dy<-20)setDir(0,-1);
  }
},{passive:true});
</script>
</body>
</html>
