<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π ‚Äî MiniGames</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º</a>

    <div id="lobby" class="lobby">
      <h1>üé® –†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π</h1>
      <div>
        <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É (—Ç—ã —Ä–∏—Å—É–µ—à—å)</button>
      </div>
      <div style="margin-top:20px">
        <input type="text" id="codeInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="6">
        <button class="btn btn-secondary" onclick="joinRoom()">–í–æ–π—Ç–∏ (—É–≥–∞–¥—ã–≤–∞–µ—à—å)</button>
      </div>
      <div id="roomInfo" class="hidden">
        <div class="room-code" id="roomCode"></div>
        <div class="info-bar">–ò–≥—Ä–æ–∫–æ–≤: <span id="playerCount">1</span>/4</div>
        <div id="wordSetup" class="hidden" style="margin-top:15px">
          <p>–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è:</p>
          <input type="text" id="wordInput" placeholder="–°–ª–æ–≤–æ">
          <button class="btn" onclick="setWord()">–ù–∞—á–∞—Ç—å!</button>
        </div>
      </div>
    </div>

    <div id="gameScreen" class="game-area hidden">
      <div class="info-bar" id="hintBar">–û–∂–∏–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞...</div>

      <canvas id="c" width="600" height="400"></canvas>

      <div id="drawTools" class="hidden">
        <div class="color-picker">
          <div class="color-btn active" style="background:#fff" onclick="setColor('#fff',this)"></div>
          <div class="color-btn" style="background:#e74c3c" onclick="setColor('#e74c3c',this)"></div>
          <div class="color-btn" style="background:#3498db" onclick="setColor('#3498db',this)"></div>
          <div class="color-btn" style="background:#2ecc71" onclick="setColor('#2ecc71',this)"></div>
          <div class="color-btn" style="background:#f39c12" onclick="setColor('#f39c12',this)"></div>
          <div class="color-btn" style="background:#9b59b6" onclick="setColor('#9b59b6',this)"></div>
          <div class="color-btn" style="background:#111" onclick="setColor('#111',this)"></div>
        </div>
        <button class="btn btn-secondary" onclick="clearC()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div id="chat">
        <div id="chat-messages"></div>
        <div id="guessArea">
          <input type="text" id="guessInput" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç..." 
            style="width:70%" onkeydown="if(event.key==='Enter')sendGuess()">
          <button class="btn" onclick="sendGuess()">‚Üí</button>
        </div>
      </div>
    </div>
  </div>

<script>
const socket = io();
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let isDrawer = false;
let drawing = false;
let color = '#fff';
let lastPos = null;

function createRoom() {
  socket.emit('createRoom', 'draw', (code) => {
    isDrawer = true;
    document.getElementById('roomCode').textContent = code;
    document.getElementById('roomInfo').classList.remove('hidden');
    document.getElementById('wordSetup').classList.remove('hidden');
  });
}

function joinRoom() {
  const code = document.getElementById('codeInput').value.toUpperCase();
  socket.emit('joinRoom', code, (res) => {
    if (res.error) return alert(res.error);
    isDrawer = false;
    showGame();
  });
}

socket.on('playerJoined', (count) => {
  document.getElementById('playerCount').textContent = count;
});

function setWord() {
  const word = document.getElementById('wordInput').value.trim();
  if (!word) return;
  socket.emit('setWord', word);
  showGame();
  document.getElementById('hintBar').textContent = '–¢—ã —Ä–∏—Å—É–µ—à—å: ' + word;
  document.getElementById('drawTools').classList.remove('hidden');
  document.getElementById('guessArea').classList.add('hidden');
}

function showGame() {
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, 600, 400);
}

socket.on('wordHint', (hint) => {
  document.getElementById('hintBar').textContent = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: ' + hint;
});

// –†–ò–°–û–í–ê–ù–ò–ï
canvas.addEventListener('mousedown', (e) => {
  if (!isDrawer) return;
  drawing = true;
  lastPos = getPos(e);
});

canvas.addEventListener('mousemove', (e) => {
  if (!drawing || !isDrawer) return;
  const pos = getPos(e);
  drawLine(lastPos, pos, color);
  socket.emit('drawLine', {from: lastPos, to: pos, color});
  lastPos = pos;
});

canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mouseleave', () => drawing = false);

// –¢–∞—á-–ø–æ–¥–¥–µ—Ä–∂–∫–∞
canvas.addEventListener('touchstart', (e) => {
  if (!isDrawer) return;
  e.preventDefault();
  drawing = true;
  lastPos = getTouchPos(e);
});

canvas.addEventListener('touchmove', (e) => {
  if (!drawing || !isDrawer) return;
  e.preventDefault();
  const pos = getTouchPos(e);
  drawLine(lastPos, pos, color);
  socket.emit('drawLine', {from: lastPos, to: pos, color});
  lastPos = pos;
});

canvas.addEventListener('touchend', () => drawing = false);

function getPos(e) {
  const r = canvas.getBoundingClientRect();
  return {x: e.clientX - r.left, y: e.clientY - r.top};
}

function getTouchPos(e) {
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  return {x: t.clientX - r.left, y: t.clientY - r.top};
}

function drawLine(from, to, c) {
  ctx.strokeStyle = c;
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
}

socket.on('drawLine', (data) => {
  drawLine(data.from, data.to, data.color);
});

function setColor(c, el) {
  color = c;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function clearC() {
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, 600, 400);
  socket.emit('clearCanvas');
}

socket.on('clearCanvas', () => {
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, 600, 400);
});

// –ß–ê–¢
function sendGuess() {
  const input = document.getElementById('guessInput');
  const msg = input.value.trim();
  if (!msg) return;
  socket.emit('chatMsg', msg);
  addMsg('–¢—ã: ' + msg);
  input.value = '';
}

socket.on('chatMsg', (data) => {
  addMsg('–ò–≥—Ä–æ–∫: ' + data.msg);
});

socket.on('correctGuess', (data) => {
  addMsg('‚úÖ –£–≥–∞–¥–∞–Ω–æ! –°–ª–æ–≤–æ: ' + data.word, true);
  document.getElementById('hintBar').textContent = 'üéâ –°–ª–æ–≤–æ —É–≥–∞–¥–∞–Ω–æ: ' + data.word;
});

function addMsg(text, correct) {
  const div = document.getElementById('chat-messages');
  const p = document.createElement('p');
  p.textContent = text;
  if (correct) p.className = 'correct';
  div.appendChild(p);
  div.scrollTop = div.scrollHeight;
}
</script>
</body>
</html>
