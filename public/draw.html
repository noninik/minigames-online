<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π ‚Äî MiniGames</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>

    <div id="lobby" class="lobby">
      <h1>üé® –†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π</h1>
      <div>
        <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å (—Ç—ã —Ä–∏—Å—É–µ—à—å)</button>
      </div>
      <div style="margin-top:15px">
        <input type="text" id="codeInput" placeholder="–ö–æ–¥" maxlength="6">
        <button class="btn btn-secondary" onclick="joinRoom()">–í–æ–π—Ç–∏ (—É–≥–∞–¥—ã–≤–∞–µ—à—å)</button>
      </div>
      <div id="roomInfo" class="hidden">
        <div class="room-code" id="roomCode"></div>
        <div class="info-bar">–ò–≥—Ä–æ–∫–æ–≤: <span id="playerCount">1</span>/4</div>
        <div id="wordSetup" class="hidden" style="margin-top:12px">
          <p>–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ:</p>
          <input type="text" id="wordInput" placeholder="–°–ª–æ–≤–æ">
          <button class="btn" onclick="setWord()">–ù–∞—á–∞—Ç—å!</button>
        </div>
      </div>
    </div>

    <div id="gameScreen" class="game-area hidden">
      <div class="info-bar" id="hintBar">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      <canvas id="c"></canvas>

      <div id="drawTools" class="hidden">
        <div class="color-picker">
          <div class="color-btn active" style="background:#fff" onclick="setClr('#fff',this)"></div>
          <div class="color-btn" style="background:#e74c3c" onclick="setClr('#e74c3c',this)"></div>
          <div class="color-btn" style="background:#3498db" onclick="setClr('#3498db',this)"></div>
          <div class="color-btn" style="background:#2ecc71" onclick="setClr('#2ecc71',this)"></div>
          <div class="color-btn" style="background:#f39c12" onclick="setClr('#f39c12',this)"></div>
          <div class="color-btn" style="background:#9b59b6" onclick="setClr('#9b59b6',this)"></div>
          <div class="color-btn" style="background:#111" onclick="setClr('#111',this)"></div>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="clearC()" style="padding:8px 20px;font-size:0.9em">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="sz=3" style="padding:8px 12px;font-size:0.9em">–¢–æ–Ω–∫–∞—è</button>
          <button class="btn btn-secondary" onclick="sz=8" style="padding:8px 12px;font-size:0.9em">–¢–æ–ª—Å—Ç–∞—è</button>
        </div>
      </div>

      <div id="chat">
        <div id="chat-messages"></div>
        <div id="guessArea">
          <input type="text" id="guessInput" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç..."
            onkeydown="if(event.key==='Enter')sendGuess()">
          <button class="btn" onclick="sendGuess()">‚Üí</button>
        </div>
      </div>
    </div>
  </div>

<script>
const socket = io();
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let isDrawer=false, drawing=false, color='#fff', lastPos=null, sz=3;
let cW, cH, scaleX=1, scaleY=1;

function resize(){
  cW=Math.min(window.innerWidth-30,600);
  cH=Math.round(cW*0.67);
  scaleX=cW/600; scaleY=cH/400;
  canvas.width=cW; canvas.height=cH;
  ctx.fillStyle='#111'; ctx.fillRect(0,0,cW,cH);
}
resize();
window.addEventListener('resize',resize);

function createRoom(){
  socket.emit('createRoom','draw',(code)=>{
    isDrawer=true;
    document.getElementById('roomCode').textContent=code;
    document.getElementById('roomInfo').classList.remove('hidden');
    document.getElementById('wordSetup').classList.remove('hidden');
  });
}

function joinRoom(){
  const code=document.getElementById('codeInput').value.toUpperCase();
  socket.emit('joinRoom',code,(res)=>{
    if(res.error) return alert(res.error);
    isDrawer=false; showGame();
  });
}

socket.on('playerJoined',(c)=>{document.getElementById('playerCount').textContent=c;});

function setWord(){
  const w=document.getElementById('wordInput').value.trim();
  if(!w)return;
  socket.emit('setWord',w); showGame();
  document.getElementById('hintBar').textContent='–¢—ã —Ä–∏—Å—É–µ—à—å: '+w;
  document.getElementById('drawTools').classList.remove('hidden');
  document.getElementById('guessArea').classList.add('hidden');
}

function showGame(){
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  resize();
}

socket.on('wordHint',(h)=>{document.getElementById('hintBar').textContent='–ü–æ–¥—Å–∫–∞–∑–∫–∞: '+h;});

function getPos(e){
  const r=canvas.getBoundingClientRect();
  return {x:(e.clientX-r.left)/scaleX, y:(e.clientY-r.top)/scaleY};
}
function getTPos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches[0];
  return {x:(t.clientX-r.left)/scaleX, y:(t.clientY-r.top)/scaleY};
}

canvas.addEventListener('mousedown',(e)=>{if(!isDrawer)return;drawing=true;lastPos=getPos(e);});
canvas.addEventListener('mousemove',(e)=>{
  if(!drawing||!isDrawer)return;
  const p=getPos(e); drawLine(lastPos,p,color,sz);
  socket.emit('drawLine',{from:lastPos,to:p,color,sz}); lastPos=p;
});
canvas.addEventListener('mouseup',()=>drawing=false);
canvas.addEventListener('mouseleave',()=>drawing=false);

canvas.addEventListener('touchstart',(e)=>{
  if(!isDrawer)return; e.preventDefault(); drawing=true; lastPos=getTPos(e);
});
canvas.addEventListener('touchmove',(e)=>{
  if(!drawing||!isDrawer)return; e.preventDefault();
  const p=getTPos(e); drawLine(lastPos,p,color,sz);
  socket.emit('drawLine',{from:lastPos,to:p,color,sz}); lastPos=p;
});
canvas.addEventListener('touchend',(e)=>{e.preventDefault();drawing=false;});

function drawLine(a,b,c,s){
  ctx.strokeStyle=c; ctx.lineWidth=s*scaleX; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(a.x*scaleX,a.y*scaleY);
  ctx.lineTo(b.x*scaleX,b.y*scaleY); ctx.stroke();
}

socket.on('drawLine',(d)=>{drawLine(d.from,d.to,d.color,d.sz||3);});

function setClr(c,el){
  color=c;
  document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

function clearC(){
  ctx.fillStyle='#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
  socket.emit('clearCanvas');
}
socket.on('clearCanvas',()=>{ctx.fillStyle='#111';ctx.fillRect(0,0,canvas.width,canvas.height);});

function sendGuess(){
  const inp=document.getElementById('guessInput');
  const m=inp.value.trim(); if(!m)return;
  socket.emit('chatMsg',m); addMsg('–¢—ã: '+m); inp.value='';
}
socket.on('chatMsg',(d)=>{addMsg('–ò–≥—Ä–æ–∫: '+d.msg);});
socket.on('correctGuess',(d)=>{
  addMsg('‚úÖ –£–≥–∞–¥–∞–Ω–æ! –°–ª–æ–≤–æ: '+d.word,true);
  document.getElementById('hintBar').textContent='üéâ –£–≥–∞–¥–∞–Ω–æ: '+d.word;
});
function addMsg(t,ok){
  const div=document.getElementById('chat-messages');
  const p=document.createElement('p'); p.textContent=t;
  if(ok)p.className='correct'; div.appendChild(p); div.scrollTop=div.scrollHeight;
}
</script>
</body>
</html>
