<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π ‚Äî MiniGames</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .scoreboard {
      background: #1a1a2e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px 15px;
      margin: 10px 0;
      width: 100%;
      max-width: 600px;
    }
    .scoreboard h3 {
      color: #667eea;
      margin-bottom: 8px;
      font-size: 1em;
    }
    .sb-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      color: #ccc;
      font-size: 0.9em;
    }
    .sb-row.drawer { color: #f39c12; }
    .sb-score { font-weight: bold; color: #2ecc71; }
    .word-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .word-overlay h2 { color: #2ecc71; font-size: 1.8em; margin-bottom: 10px; }
    .word-overlay p { color: #ccc; font-size: 1.1em; }
    .word-input-area { margin-top: 12px; text-align: center; }
    .round-badge {
      background: #667eea; color: #fff;
      padding: 3px 12px; border-radius: 15px;
      font-size: 0.85em; margin-right: 8px;
    }
    .copy-btn {
      background: none; border: 1px solid #667eea;
      color: #667eea; padding: 6px 14px; border-radius: 8px;
      cursor: pointer; font-size: 0.9em; margin-top: 8px;
    }
    .copy-btn:active { background: #667eea; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>

    <!-- –õ–û–ë–ë–ò -->
    <div id="lobby" class="lobby">
      <h1>üé® –†–∏—Å—É–π –∏ –£–≥–∞–¥–∞–π</h1>
      <div>
        <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      </div>
      <div style="margin-top:15px">
        <input type="text" id="codeInput" placeholder="–ö–æ–¥" maxlength="6">
        <button class="btn btn-secondary" onclick="joinRoom()">–í–æ–π—Ç–∏</button>
      </div>
      <div id="roomInfo" class="hidden">
        <div class="room-code" id="roomCode"></div>
        <button class="copy-btn" onclick="copyCode()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <div class="info-bar" style="margin-top:10px">
          –ò–≥—Ä–æ–∫–æ–≤: <span id="playerCount">1</span>/4
        </div>
        <button class="btn" style="margin-top:12px" onclick="startFirst()">üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <p id="waitMsg" class="hidden" style="color:#f39c12;margin-top:10px">
          –ñ–¥—ë–º –ø–æ–∫–∞ —Ö–æ—Å—Ç –Ω–∞—á–Ω—ë—Ç –∏–≥—Ä—É...
        </p>
      </div>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="gameScreen" class="game-area hidden">
      <div class="info-bar" id="hintBar">
        <span class="round-badge" id="roundBadge">–†–∞—É–Ω–¥ 1</span>
        <span id="hintText">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
      </div>

      <canvas id="c"></canvas>

      <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
      <div id="drawTools" class="hidden">
        <div class="color-picker">
          <div class="color-btn active" style="background:#fff" onclick="setClr('#fff',this)"></div>
          <div class="color-btn" style="background:#e74c3c" onclick="setClr('#e74c3c',this)"></div>
          <div class="color-btn" style="background:#3498db" onclick="setClr('#3498db',this)"></div>
          <div class="color-btn" style="background:#2ecc71" onclick="setClr('#2ecc71',this)"></div>
          <div class="color-btn" style="background:#f39c12" onclick="setClr('#f39c12',this)"></div>
          <div class="color-btn" style="background:#9b59b6" onclick="setClr('#9b59b6',this)"></div>
          <div class="color-btn" style="background:#111" onclick="setClr('#111',this)"></div>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="clearC()" style="padding:8px 15px;font-size:0.85em">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="sz=2" style="padding:8px 12px;font-size:0.85em">–¢–æ–Ω–∫–∞—è</button>
          <button class="btn btn-secondary" onclick="sz=5" style="padding:8px 12px;font-size:0.85em">–°—Ä–µ–¥–Ω—è—è</button>
          <button class="btn btn-secondary" onclick="sz=10" style="padding:8px 12px;font-size:0.85em">–¢–æ–ª—Å—Ç–∞—è</button>
        </div>
        <div class="word-input-area" id="wordInputArea">
          <input type="text" id="wordInput" placeholder="–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è">
          <button class="btn" onclick="setWord()">üé® –†–∏—Å–æ–≤–∞—Ç—å!</button>
        </div>
      </div>

      <!-- –¢–∞–±–ª–æ -->
      <div class="scoreboard" id="scoreboard">
        <h3>üìä –°—á—ë—Ç</h3>
        <div id="scoreRows"></div>
      </div>

      <!-- –ß–∞—Ç -->
      <div id="chat">
        <div id="chat-messages"></div>
        <div id="guessArea">
          <input type="text" id="guessInput" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç..."
            onkeydown="if(event.key==='Enter')sendGuess()">
          <button class="btn" onclick="sendGuess()">‚Üí</button>
        </div>
      </div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π -->
    <div id="overlay" class="word-overlay hidden">
      <h2 id="overlayTitle">‚úÖ –£–≥–∞–¥–∞–Ω–æ!</h2>
      <p id="overlayWord"></p>
      <p id="overlayNext" style="margin-top:15px;color:#888"></p>
    </div>
  </div>

<script>
const socket = io();
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let isDrawer = false;
let isHost = false;
let drawing = false;
let color = '#fff';
let lastPos = null;
let sz = 3;
let cW, cH, scaleX = 1, scaleY = 1;
let myId = null;
let myRoomCode = '';
let players = [];
let currentDrawerIndex = 0;

socket.on('connect', () => { myId = socket.id; });

function resize() {
  cW = Math.min(window.innerWidth - 30, 600);
  cH = Math.round(cW * 0.67);
  scaleX = cW / 600;
  scaleY = cH / 400;
  canvas.width = cW;
  canvas.height = cH;
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, cW, cH);
}
resize();
window.addEventListener('resize', resize);

// ==================
// –õ–û–ë–ë–ò
// ==================

function createRoom() {
  socket.emit('createRoom', 'draw', (code) => {
    myRoomCode = code;
    isHost = true;
    document.getElementById('roomCode').textContent = code;
    document.getElementById('roomInfo').classList.remove('hidden');
  });
}

function joinRoom() {
  const code = document.getElementById('codeInput').value.toUpperCase().trim();
  if (!code) return alert('–í–≤–µ–¥–∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
  socket.emit('joinRoom', code, (res) => {
    if (res.error) return alert(res.error);
    myRoomCode = code;
    isHost = false;
    if (res.players) players = res.players;
    document.getElementById('roomCode').textContent = code;
    document.getElementById('roomInfo').classList.remove('hidden');
    document.getElementById('playerCount').textContent = players.length;
    // –ì–æ—Å—Ç—å –Ω–µ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É –ù–∞—á–∞—Ç—å ‚Äî –∂–¥—ë—Ç
    document.querySelector('#roomInfo .btn').classList.add('hidden');
    document.getElementById('waitMsg').classList.remove('hidden');
  });
}

function copyCode() {
  const code = myRoomCode;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(() => {
      alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + code);
    });
  } else {
    // –§–æ–ª–ª–±–µ–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
    const ta = document.createElement('textarea');
    ta.value = code;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + code);
  }
}

socket.on('playerJoined', (data) => {
  document.getElementById('playerCount').textContent = data.count;
  if (data.players) players = data.players;
});

socket.on('playerLeft', (data) => {
  if (data.players) players = data.players;
  document.getElementById('playerCount').textContent = data.count;
  updateScoreboard();
});

// ==================
// –ù–ê–ß–ê–õ–û –ò–ì–†–´
// ==================

function startFirst() {
  if (players.length < 1) {
    // –î–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω ‚Äî –ø—É—Å—Ç—å –Ω–∞—á–Ω—ë—Ç (–¥–ª—è —Ç–µ—Å—Ç–∞)
  }
  // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É —á—Ç–æ –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å
  socket.emit('drawGameStart');
}

// –•–æ—Å—Ç –Ω–∞–∂–∞–ª –ù–∞—á–∞—Ç—å ‚Äî –≤—Å–µ –ø–æ–ª—É—á–∞—é—Ç —Å–∏–≥–Ω–∞–ª
socket.on('drawGameStarted', (data) => {
  if (data.players) players = data.players;
  currentDrawerIndex = data.drawerIndex;
  updateScoreboard();
  showGame();

  if (data.drawerId === myId) {
    becomeDrawer();
  } else {
    becomeGuesser(data.drawerName);
  }
  addMsg('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! ' + data.drawerName + ' —Ä–∏—Å—É–µ—Ç –ø–µ—Ä–≤—ã–º', false, true);
});

function showGame() {
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  resize();
}

// ==================
// –†–û–õ–ò
// ==================

function becomeDrawer() {
  isDrawer = true;
  document.getElementById('drawTools').classList.remove('hidden');
  document.getElementById('wordInputArea').classList.remove('hidden');
  document.getElementById('guessArea').classList.add('hidden');
  document.getElementById('hintText').textContent = '‚úèÔ∏è –í–≤–µ–¥–∏ —Å–ª–æ–≤–æ –∏ –Ω–∞—á–Ω–∏ —Ä–∏—Å–æ–≤–∞—Ç—å!';
  document.getElementById('wordInput').value = '';
  clearCanvas();
}

function becomeGuesser(drawerName) {
  isDrawer = false;
  document.getElementById('drawTools').classList.add('hidden');
  document.getElementById('guessArea').classList.remove('hidden');
  document.getElementById('hintText').textContent = 'üé® ' + drawerName + ' —Ä–∏—Å—É–µ—Ç...';
  clearCanvas();
}

// ==================
// –°–õ–û–í–û
// ==================

function setWord() {
  const w = document.getElementById('wordInput').value.trim();
  if (!w) return alert('–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ!');
  socket.emit('setWord', w);
  document.getElementById('wordInputArea').classList.add('hidden');
  document.getElementById('hintText').textContent = '–¢—ã —Ä–∏—Å—É–µ—à—å: ' + w;
}

socket.on('wordHint', (hint) => {
  document.getElementById('hintText').textContent = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: ' + hint;
});

// ==================
// –†–ê–£–ù–î–´
// ==================

socket.on('roundStart', (data) => {
  document.getElementById('roundBadge').textContent = '–†–∞—É–Ω–¥ ' + data.round;
  if (data.players) {
    players = data.players;
    updateScoreboard();
  }
});

socket.on('nextRound', (data) => {
  hideOverlay();
  document.getElementById('roundBadge').textContent = '–†–∞—É–Ω–¥ ' + data.round;
  if (data.players) {
    players = data.players;
    updateScoreboard();
  }
  currentDrawerIndex = data.drawerIndex;

  if (data.drawerId === myId) {
    becomeDrawer();
  } else {
    becomeGuesser(data.drawerName);
  }
  addMsg('--- –†–∞—É–Ω–¥ ' + data.round + ': ' + data.drawerName + ' —Ä–∏—Å—É–µ—Ç ---', false, true);
});

socket.on('correctGuess', (data) => {
  if (data.players) {
    players = data.players;
    updateScoreboard();
  }
  addMsg('‚úÖ ' + data.name + ' —É–≥–∞–¥–∞–ª! –°–ª–æ–≤–æ: ' + data.word, true);
  showOverlay(data.name, data.word);
});

// ==================
// –û–í–ï–†–õ–ï–ô
// ==================

function showOverlay(name, word) {
  document.getElementById('overlayTitle').textContent = '‚úÖ ' + name + ' —É–≥–∞–¥–∞–ª!';
  document.getElementById('overlayWord').textContent = '–°–ª–æ–≤–æ: ' + word;
  document.getElementById('overlayNext').textContent = '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —á–µ—Ä–µ–∑ 4 —Å–µ–∫...';
  document.getElementById('overlay').classList.remove('hidden');
}

function hideOverlay() {
  document.getElementById('overlay').classList.add('hidden');
}

// ==================
// –¢–ê–ë–õ–û
// ==================

function updateScoreboard() {
  const div = document.getElementById('scoreRows');
  div.innerHTML = '';
  players.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'sb-row' + (i === currentDrawerIndex ? ' drawer' : '');
    row.innerHTML =
      '<span>' + (i === currentDrawerIndex ? 'üé® ' : 'üë§ ') + p.name + '</span>' +
      '<span class="sb-score">' + p.score + ' –æ—á–∫–æ–≤</span>';
    div.appendChild(row);
  });
}

// ==================
// –†–ò–°–û–í–ê–ù–ò–ï
// ==================

function getPos(e) {
  const r = canvas.getBoundingClientRect();
  return { x: (e.clientX - r.left) / scaleX, y: (e.clientY - r.top) / scaleY };
}
function getTPos(e) {
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  return { x: (t.clientX - r.left) / scaleX, y: (t.clientY - r.top) / scaleY };
}

canvas.addEventListener('mousedown', (e) => {
  if (!isDrawer) return; drawing = true; lastPos = getPos(e);
});
canvas.addEventListener('mousemove', (e) => {
  if (!drawing || !isDrawer) return;
  const p = getPos(e);
  drawLine(lastPos, p, color, sz);
  socket.emit('drawLine', { from: lastPos, to: p, color, sz });
  lastPos = p;
});
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mouseleave', () => drawing = false);

canvas.addEventListener('touchstart', (e) => {
  if (!isDrawer) return; e.preventDefault(); drawing = true; lastPos = getTPos(e);
});
canvas.addEventListener('touchmove', (e) => {
  if (!isDrawer) return; e.preventDefault();
  const p = getTPos(e);
  drawLine(lastPos, p, color, sz);
  socket.emit('drawLine', { from: lastPos, to: p, color, sz });
  lastPos = p;
});
canvas.addEventListener('touchend', (e) => { e.preventDefault(); drawing = false; });

function drawLine(a, b, c, s) {
  ctx.strokeStyle = c;
  ctx.lineWidth = s * scaleX;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(a.x * scaleX, a.y * scaleY);
  ctx.lineTo(b.x * scaleX, b.y * scaleY);
  ctx.stroke();
}

socket.on('drawLine', (d) => { drawLine(d.from, d.to, d.color, d.sz || 3); });

function setClr(c, el) {
  color = c;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function clearC() {
  clearCanvas();
  socket.emit('clearCanvas');
}

function clearCanvas() {
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

socket.on('clearCanvas', () => { clearCanvas(); });

// ==================
// –ß–ê–¢
// ==================

function sendGuess() {
  const inp = document.getElementById('guessInput');
  const m = inp.value.trim();
  if (!m) return;
  socket.emit('chatMsg', m);
  addMsg('–¢—ã: ' + m);
  inp.value = '';
}

socket.on('chatMsg', (d) => {
  addMsg(d.name + ': ' + d.msg);
});

function addMsg(text, correct, system) {
  const div = document.getElementById('chat-messages');
  const p = document.createElement('p');
  p.textContent = text;
  if (correct) p.className = 'correct';
  if (system) p.style.color = '#667eea';
  div.appendChild(p);
  div.scrollTop = div.scrollHeight;
}
</script>
</body>
</html>
